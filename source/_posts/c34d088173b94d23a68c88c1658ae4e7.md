---
layout: post
title: WMS 动画
abbrlink: c34d088173b94d23a68c88c1658ae4e7
tags: []
categories:
  - framework
  - window
date: 1756880292961
updated: 1756894048821
---

## 本地动画

运行在 systemserver

## 远端动画

运行在 非 systemserver 端\
eg: launcher\
![423278915dc9879c2418cdb9ce0c3834.png](/resources/87b628e661fb4948b94864de30a2850b.png)

![829ad7de9ca16aae98a241419aef75c7.png](/resources/20717506855c476eb24b4719ab3f3361.png)\
![0c204d7eb7f9e05ace6c0ff44d74cfff.png](/resources/19ea36d4e77f40e5aa2ae4476c339420.png)

![1625e0657592d474e930b1f3c57812e7.png](/resources/86de96f02dda489cafc10d3807d66e2f.png)

![8eaaad00671de13f78c6816589f9ffc2.png](/resources/211932914b014c34aa1e024958381380.png)

```java
// 动画移除
static boolean removeLeash(Transaction t, Animatable animatable, @NonNull SurfaceControl leash,
        boolean destroy) {
    boolean scheduleAnim = false;
    final SurfaceControl surface = animatable.getSurfaceControl();
    final SurfaceControl parent = animatable.getParentSurfaceControl();

    // If the surface was destroyed or the leash is invalid, we don't care to reparent it back.
    // Note that we also set this variable to true even if the parent isn't valid anymore, in
    // order to ensure onAnimationLeashLost still gets called in this case.
    final boolean reparent = surface != null;
    if (reparent) {
        if (DEBUG_ANIM) Slog.i(TAG, "Reparenting to original parent: " + parent);
        // We shouldn't really need these isValid checks but we do
        // b/130364451
        if (surface.isValid() && parent != null && parent.isValid()) {
            t.reparent(surface, parent);
            scheduleAnim = true;
        }
    }
    if (destroy) {
        t.remove(leash);
        scheduleAnim = true;
    }

    if (reparent) {
        // Make sure to inform the animatable after the surface was reparented (or reparent
        // wasn't possible, but we still need to invoke the callback)
        animatable.onAnimationLeashLost(t);
        scheduleAnim = true;
    }
    return scheduleAnim;
}
```

## 总结

当设置了 `windowAnimations` 时, 会添加一个用于执行动画的节点到原WindowState 父节点下(包装自己),动画执行结束后,会重新挂载自己到父节点下,同时移除动画节点(leash)
