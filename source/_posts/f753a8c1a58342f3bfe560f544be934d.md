---
layout: post
title: ANR OOM
abbrlink: f753a8c1a58342f3bfe560f544be934d
tags: []
categories:
  - Mac笔记本
  - 金狮
date: 1717136716367
updated: 1746779701395
---

## ANR

- 前台服务 20s
- 后台服务200s
- 前台广播 10s
- 后台广播 60s
- ContentProvider 10s
- 输入时间超时 5s 。包括按键和触摸事件

## 处理

1. 定位时间点
2. 查看trace信息
3. 分享是否有耗时调用,锁竞争
4. 结合具体业务分析

> 目录 data/anr

## 避免

1. 耗时操作避免在主线程进行
   1. 复杂的ui绘制,
   2. 网络操作,
   3. 文件IO操作
2. 避免主线程与工作线程发生锁的竞争,减少系统Binder调用,谨慎使用 SharePreference (commit)

> 减少主线程负载.

## Message Looper print监听

缺点: 无法定位卡顿真实原因
发生卡顿的函数(及其调用栈)可能不是真正的耗时函数(真正的耗时函数可能已经执行过了)

## matrix

## 三方框架检测

### FaceBook(系统API查询)

#### 优点

- 依赖系统API
- 检测间隔短
- 实现简单,代码量少

#### 缺点

- 依赖系统API,某些Android版本可能受限
- 只能检测已发生ANR, 无法预警
- 需要`GET_TASKS`权限

```java
@AutoHandleExceptions
@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)
object ANRDetector {
  private const val DETECTION_INTERVAL_IN_MS = 500
  private val myUid = Process.myUid() // the identity of its app-specific sandbox.
  private val scheduledExecutorService = Executors.newSingleThreadScheduledExecutor()
  private var previousStackTrace: String? = ""
  private val anrDetectorRunnable = Runnable {
    try {
      val am: ActivityManager? =
          FacebookSdk.getApplicationContext().getSystemService(Context.ACTIVITY_SERVICE)
              as ActivityManager
      checkProcessError(am)
    } catch (e: Exception) {
      /*no op*/
    }
  }

  @JvmStatic
  @VisibleForTesting
  fun checkProcessError(am: ActivityManager?) {
    am?.processesInErrorState?.forEach { info ->
      if (info.condition == ActivityManager.ProcessErrorStateInfo.NOT_RESPONDING &&
          info.uid == myUid) {
        val mainThread = Looper.getMainLooper().thread
        val stackTrace = getStackTrace(mainThread)
        if (stackTrace == previousStackTrace || !isSDKRelatedThread(mainThread)) {
          return@forEach
        }
        previousStackTrace = stackTrace
        build(info.shortMsg, stackTrace).save()
      }
    }
  }

  // Should be only called by ANRHandler
  @JvmStatic
  @VisibleForTesting
  fun start() {
    scheduledExecutorService.scheduleWithFixedDelay(
        anrDetectorRunnable, 0, DETECTION_INTERVAL_IN_MS.toLong(), TimeUnit.MILLISECONDS)
  }
}

```

### FirebaseSDK
