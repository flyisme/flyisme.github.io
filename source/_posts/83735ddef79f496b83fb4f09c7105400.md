---
layout: post
title: Matrixæ’æ¡©é€‚é… AGP8 è§£æ
abbrlink: 83735ddef79f496b83fb4f09c7105400
tags:
  - ç¬¬ä¸‰æ–¹æ¡†æ¶
  - æ€§èƒ½ä¼˜åŒ–
categories:
  - Macç¬”è®°æœ¬
  - Android
  - æ€§èƒ½è°ƒä¼˜
date: 1750298240121
updated: 1751022017911
---

## 1. é¡¹ç›®èƒŒæ™¯

æœ¬æ–‡åŸºäºå®é™…çš„ Matrix TraceCanary é€‚é… AGP8 é¡¹ç›®ï¼Œæ·±å…¥åˆ†æ

## 2. MatrixTracePlugin æ ¸å¿ƒå®ç°è§£æ

### 2.1 æ’ä»¶æ¶æ„è®¾è®¡

```kotlin
class MatrixTracePlugin : Plugin<Project> {
    override fun apply(project: Project) {
        // 1. åˆ›å»ºæ‰©å±•é…ç½®
        val matrix = project.extensions.create("matrix", MatrixExtension::class.java)
        val traceExtension = (matrix as ExtensionAware).extensions
            .create("trace", MatrixTraceExtension::class.java)

        // 2. éªŒè¯ Android Application æ’ä»¶
        if (!project.plugins.hasPlugin("com.android.application")) {
            throw GradleException("Matrix Plugin, Android Application plugin required.")
        }

        // 3. é…ç½®æ—¥å¿—çº§åˆ«
        project.afterEvaluate {
            Log.setLogLevel(matrix.logLevel)
        }

        // 4. æ³¨å†Œ Instrumentation
        val androidComponents = project.extensions
            .getByType(AndroidComponentsExtension::class.java)
        androidComponents.onVariants { variant ->
            configureVariant(project, variant, traceExtension)
        }
    }
}
```

**å…³é”®è®¾è®¡ç‚¹ï¼š**

- ä½¿ç”¨ `AndroidComponentsExtension` æ›¿ä»£æ—§çš„ Transform æ³¨å†Œæ–¹å¼
- é€šè¿‡ `onVariants` å›è°ƒä¸ºæ¯ä¸ªæ„å»ºå˜ä½“å•ç‹¬é…ç½®
- å»¶è¿Ÿé…ç½®ç¡®ä¿æ‰€æœ‰ä¾èµ–é¡¹å·²å°±ç»ª

### 2.2 å˜ä½“é…ç½®æ ¸å¿ƒé€»è¾‘

```kotlin
private fun configureVariant(
    project: Project,
    variant: Variant,
    extension: MatrixTraceExtension
) {
    // 1. è®¾ç½® ASM å¸§è®¡ç®—æ¨¡å¼
    variant.instrumentation.setAsmFramesComputationMode(
        FramesComputationMode.COPY_FRAMES
    )

    // 2. æ³¨å†Œå­—èŠ‚ç è½¬æ¢å™¨
    variant.instrumentation.transformClassesWith(
        MatrixTraceClassVisitorFactory::class.java,
        InstrumentationScope.ALL
    ) { params ->
        configureInstrumentationParams(params, project, extension)
    }

    // 3. è®¾ç½®æ–¹æ³•æ˜ å°„ä¿å­˜ä»»åŠ¡
    setupMappingSaveTask(project, variant)
}
```

### 2.3 é»‘åå•å¤„ç†æœºåˆ¶

```kotlin
// å¤„ç†é»‘åå•æ–‡ä»¶çš„æ ¸å¿ƒé€»è¾‘
extension.blackListFile?.let { blockFile ->
    if (File(blockFile).exists()) {
        val buildDir = project.layout.buildDirectory.get().asFile
        val mappingFile = buildDir.resolve("outputs/matrix/mapping/${variant.name}").resolve("methodMapping.txt")
		//ç¼“å­˜ å…¼å®¹: cleanåä¼šåˆ é™¤ mappingFile ,æ­¤æ—¶åº”è¯¥é‡æ–°èµ°æ‰€æœ‰æ’æ¡©æµç¨‹
		params.cacheFlag.set(mappingFile.exists())params.blockListFilePath.set(project.file(blockFile).absolutePath)

        // è§£æé»‘åå•å†…å®¹
        val blockStr = (TraceBuildConstants.DEFAULT_BLOCK_TRACE
                + FileUtil.readFileAsString(project.file(blockFile).absolutePath))

        val blockArray = blockStr.trim().replace("/", ".").replace("\r", "")
            .split("\n").dropLastWhile { it.isEmpty() }.toTypedArray()

        val processor = MappingCollector()
        val blockSet = hashSetOf<String>()
        
        for (block in blockArray) {
            when {
                block.startsWith("-keepclass ") -> {
                    val className = block.replace("-keepclass ", "")
                    blockSet.add(processor.proguardClassName(className, className))
                }
                block.startsWith("-keeppackage ") -> {
                    val packageName = block.replace("-keeppackage ", "")
                    blockSet.add(processor.proguardPackageName(packageName, packageName))
                }
            }
        }
        params.blockSet.set(blockSet)
		//è®¾ç½®æœ¬åœ°æ—§mapping
        loadMethodMapping(mappingFile)
    }
}
```

**å®ç°ç‰¹ç‚¹ï¼š**

- æ”¯æŒ ProGuard é£æ ¼çš„é…ç½®è¯­æ³•
- åŒºåˆ†ç±»çº§åˆ«å’ŒåŒ…çº§åˆ«çš„è¿‡æ»¤è§„åˆ™
- ä½¿ç”¨ `MappingCollector` å¤„ç†æ··æ·†æ˜ å°„

### 2.4 æ–¹æ³•æ˜ å°„ä¿å­˜ä»»åŠ¡

```kotlin
private fun setupMappingSaveTask(project: Project, variant: Variant) {
    val variantName = variant.name.capitalize()
    val saveMappingTask = project.tasks.register("saveMapping$variantName") { task ->
        task.group = "matrix"
        task.description = "Save method mapping for $variantName"
        task.doLast {
            // æ£€æŸ¥å½“å‰æ˜¯å¦æ­£åœ¨æ„å»ºè¯¥å˜ä½“
            val isCurrentVariantBuilding = project.gradle.startParameter.taskNames
                .any { taskName ->
                    taskName.contains(variant.name, ignoreCase = true) ||
                    taskName.contains("assemble${variantName}", ignoreCase = true)
                }

            if (!isCurrentVariantBuilding) return@doLast

            // ä¿å­˜æ–¹æ³•æ˜ å°„æ–‡ä»¶
            val buildDir = project.layout.buildDirectory.get().asFile
            val mappingOutDir = buildDir.resolve("outputs/matrix/mapping/${variant.name}")
            mappingOutDir.mkdirs()
            
            val mappingFile = mappingOutDir.resolve("methodMapping.txt")
            if (mappingFile.exists()) {
                    mappingFile.delete() // å¦‚æœæ–‡ä»¶å­˜åœ¨å°±åˆ é™¤
            }
            mappingFile.createNewFile()
            saveMethodMapping(mappingFile)
        }
    }

    // é…ç½®ä»»åŠ¡ä¾èµ–å…³ç³»
    project.afterEvaluate {
        val mappingTask = saveMappingTask.get()
        
        // Transform ä»»åŠ¡å®Œæˆåæ‰§è¡Œ
        project.tasks.matching { task ->
            task.name.contains("transform")
        }.configureEach { transformTask ->
            transformTask.finalizedBy(mappingTask)
        }

        // Assemble ä»»åŠ¡ä¾èµ–æ˜ å°„ä¿å­˜
        project.tasks.matching { task ->
            task.name.contains("assemble") &&
            task.name.contains(variant.name, ignoreCase = true)
        }.forEach { assembleTask ->
            assembleTask.dependsOn(saveMappingTask)
        }
    }
}
```

**å…³é”®ä¼˜åŒ–ï¼š**

- æ™ºèƒ½æ£€æµ‹å½“å‰æ„å»ºå˜ä½“ï¼Œé¿å…ä¸å¿…è¦çš„ä»»åŠ¡æ‰§è¡Œ
- ä½¿ç”¨æ–°çš„ Gradle API `project.layout.buildDirectory`
- åˆç†çš„ä»»åŠ¡ä¾èµ–å…³ç³»ç¡®ä¿æ˜ å°„æ–‡ä»¶åŠæ—¶ç”Ÿæˆ

## 3. MatrixTraceClassVisitorFactory æ·±åº¦è§£æ

### 3.1 å‚æ•°æ¥å£è®¾è®¡

```kotlin
interface Params : InstrumentationParameters {
	// ç¼“å­˜å ä½: æœ‰å‚æ•°å˜æ›´ä¼šè§¦å‘å…¨é‡æ’æ¡©æ“ä½œ
    @get:Input
    val cacheFlag: Property<Boolean>
	
    @get:Input
    val packageName: Property<String>

    @get:Input
    val blockListFilePath: Property<String>

    @get:Input
    val skipCheckClass: Property<Boolean>

    @get:Input
    val blockSet: SetProperty<String>
}
```

**æ³¨æ„ï¼š**

- ä½¿ç”¨ Gradle Property API ç¡®ä¿ç±»å‹å®‰å…¨å’Œç¼“å­˜æ”¯æŒ
- `@Input` æ³¨è§£æ”¯æŒå¢é‡æ„å»º
- `SetProperty<String>` é«˜æ•ˆå¤„ç†é»‘åå•é›†åˆ

### 3.2 ç±»è¿‡æ»¤æœºåˆ¶

```kotlin
override fun isInstrumentable(classData: ClassData): Boolean {
    var isNeed = true

    // æ£€æŸ¥ç±»æ˜¯å¦åœ¨é»‘åå•ä¸­
    if (parameters.get().blockSet.get().contains(classData.className)) {
        isNeed = false
    } else {
        // æ£€æŸ¥åŒ…åæ˜¯å¦åœ¨é»‘åå•ä¸­
        for (packageName in parameters.get().blockSet.get()) {
            if (classData.className.startsWith(packageName.replace("/", "."))) {
                isNeed = false
                break
            }
        }
    }
    return isNeed
}
```

**è¿‡æ»¤ç­–ç•¥ï¼š**

- ç²¾ç¡®ç±»ååŒ¹é…ä¼˜å…ˆçº§æœ€é«˜
- åŒ…åå‰ç¼€åŒ¹é…ä½œä¸ºè¡¥å……
- æ—©æœŸè¿‡æ»¤å‡å°‘åç»­å¤„ç†å¼€é”€

### 3.3 æ–¹æ³• ID ç”Ÿæˆä¸ç®¡ç†

```kotlin
companion object {
    private val methodIdGenerator = AtomicInteger(1)
    private val methodMap = ConcurrentHashMap<String, Int>()

    fun getOrCreateMethodId(className: String, methodName: String, desc: String): Long {
            val signature = "$className.$methodName$desc".replace("/", ".")
            return methodMap.computeIfAbsent(signature) {
                methodIdGenerator.getAndIncrement()
            }
        }

    fun saveMethodMapping(outputFile: File) {
            outputFile.bufferedWriter().use { writer ->
                val sortedByValue = methodMap.entries.sortedWith(compareBy { it.value })
                sortedByValue.forEach { (signature, id) ->
                    writer.write("$id,${signature}\n")
                }
                if (methodMap["message_dispatch_start"] == null) {
                    // å†™å…¥æœ€åä¸€è¡Œï¼Œæ ‡è¯†æ¶ˆæ¯åˆ†å‘å¼€å§‹
                    writer.write("${0xFFFFF - 1},message_dispatch_start\n")
                    Log.e(TAG, "saveMethodMapping: ${methodMap.entries.size + 1}")
                } else {
                    Log.e(TAG, "saveMethodMapping: ${methodMap.entries.size}")
                }
            }
        }
		//åŠ è½½æœ¬åœ°æ–‡ä»¶
        fun loadMethodMapping(inputFile: File) {
            if (!inputFile.exists()) {
                Log.i(TAG, "oldMethodMapping: file not exists!")
                return
            }
            inputFile.bufferedReader().use { reader ->
                reader.forEachLine { line ->
                    val list = line.split(",")
                    if (list.isNotEmpty()) {
                        val (id, signature) = list
                        methodMap[signature] = id.toLong()
                    }
                }
            }
            methodIdGenerator.set(methodMap.size.toLong() + 1)
            Log.i(TAG, "loadMethodMapping: ${methodIdGenerator.get() - 1}")
        }
}
```

### 3.4 ç±»è®¿é—®å™¨æ ¸å¿ƒå®ç°

```kotlin
class MatrixTraceClassVisitor(
    nextClassVisitor: ClassVisitor,
    private val ps: Params
) : ClassVisitor(Opcodes.ASM9, nextClassVisitor) {
    
    private var className: String = ""
    private var isActivityOrSubClass = false
    private var hasWindowFocusMethod = false
    private var isNeedTrace = false

    override fun visit(version: Int, access: Int, name: String, 
                      signature: String?, superName: String, 
                      interfaces: Array<String?>?) {
        super.visit(version, access, name, signature, superName, interfaces)
        
        this.className = name
        this.isActivityOrSubClass = isActivityOrSubClass(className, superName)
        this.isNeedTrace = isNeedTrace(ps, className, null)
        
        // è¿‡æ»¤æŠ½è±¡ç±»å’Œæ¥å£
        if ((access and Opcodes.ACC_ABSTRACT) > 0 || 
            (access and Opcodes.ACC_INTERFACE) > 0) {
            this.isABSClass = true
        }
    }
}
```

### 3.5 æ–¹æ³•æ’æ¡©æ ¸å¿ƒé€»è¾‘

```kotlin
private class TraceMethodVisitor(
    private val api: Int,
    private val mv: MethodVisitor,
    private val access: Int,
    private val name: String,
    private val desc: String,
    private val className: String,
    // ... å…¶ä»–å‚æ•°
) : MethodVisitor(api, mv) {
    
    private val traceMethod = TraceMethod.create(
        getOrCreateMethodId(className, name, desc),
        access, className, name, desc
    )

    override fun visitCode() {
        super.visitCode()
        insertMethodEnterTrace()
    }

    override fun visitInsn(opcode: Int) {
        // åœ¨æ‰€æœ‰è¿”å›æŒ‡ä»¤å‰æ’å…¥é€€å‡ºè¿½è¸ª
        if ((opcode >= Opcodes.IRETURN && opcode <= Opcodes.RETURN) || 
            opcode == Opcodes.ATHROW) {
            insertMethodExitTrace()
        }
        super.visitInsn(opcode)
    }

    private fun insertMethodEnterTrace() {
        mv.visitLdcInsn(traceMethod.id)
        mv.visitMethodInsn(
            Opcodes.INVOKESTATIC,
            TraceBuildConstants.MATRIX_TRACE_CLASS,
            "i", "(I)V", false
        )
    }

    private fun insertMethodExitTrace() {
        mv.visitLdcInsn(traceMethod.id)
        mv.visitMethodInsn(
            Opcodes.INVOKESTATIC,
            TraceBuildConstants.MATRIX_TRACE_CLASS,
            "o", "(I)V", false
        )
    }
}
```

**æ’æ¡©ç­–ç•¥ï¼š**

- æ–¹æ³•å…¥å£ç»Ÿä¸€æ’å…¥ `i(methodId)` è°ƒç”¨
- æ‰€æœ‰é€€å‡ºç‚¹ï¼ˆåŒ…æ‹¬å¼‚å¸¸ï¼‰æ’å…¥ `o(methodId)` è°ƒç”¨
- ä½¿ç”¨æ–¹æ³• ID è€Œéå­—ç¬¦ä¸²å‡å°‘è¿è¡Œæ—¶å¼€é”€

### 3.6 Activity ç‰¹æ®Šå¤„ç†

```kotlin
private fun isActivityOrSubClass(cN: String, sN: String): Boolean {
    return cN == TraceBuildConstants.MATRIX_TRACE_ACTIVITY_CLASS ||
           cN == TraceBuildConstants.MATRIX_TRACE_V4_ACTIVITY_CLASS ||
           cN == TraceBuildConstants.MATRIX_TRACE_V7_ACTIVITY_CLASS ||
           cN == TraceBuildConstants.MATRIX_TRACE_ANDROIDX_ACTIVITY_CLASS ||
		   cN == TraceBuildConstants.MATRIX_TRACE_ANDROIDX_F_ACTIVITY_CLASS ||
           sN == TraceBuildConstants.MATRIX_TRACE_ACTIVITY_CLASS ||
           sN == TraceBuildConstants.MATRIX_TRACE_V4_ACTIVITY_CLASS ||
           sN == TraceBuildConstants.MATRIX_TRACE_V7_ACTIVITY_CLASS ||
           sN == TraceBuildConstants.MATRIX_TRACE_ANDROIDX_ACTIVITY_CLASS ||
		   sN == TraceBuildConstants.MATRIX_TRACE_ANDROIDX_F_ACTIVITY_CLASS
}

// æ’å…¥ onWindowFocusChanged æ–¹æ³•
private fun insertWindowFocusChangeMethod(
    cv: ClassVisitor, classname: String, superClassName: String
) {
    val methodVisitor = cv.visitMethod(
        Opcodes.ACC_PUBLIC, 
        TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD,
        TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD_ARGS, 
        null, null
    )
    
    methodVisitor.visitCode()
    // è°ƒç”¨çˆ¶ç±»æ–¹æ³•
    methodVisitor.visitVarInsn(Opcodes.ALOAD, 0)
    methodVisitor.visitVarInsn(Opcodes.ILOAD, 1)
    methodVisitor.visitMethodInsn(
        Opcodes.INVOKESPECIAL, superClassName,
        TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD,
        TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD_ARGS, false
    )
    
    // æ’å…¥è¿½è¸ªä»£ç 
    traceWindowFocusChangeMethod(methodVisitor, classname)
    methodVisitor.visitInsn(Opcodes.RETURN)
    methodVisitor.visitMaxs(2, 2)
    methodVisitor.visitEnd()
}
```

**Activity ä¼˜åŒ–ï¼š**

- å…¼å®¹å¤šä¸ªç‰ˆæœ¬çš„ Activity åŸºç±»
- è‡ªåŠ¨æ³¨å…¥ `onWindowFocusChanged` æ–¹æ³•ç”¨äºå¯åŠ¨è€—æ—¶ç»Ÿè®¡
- ä¿æŒåŸæœ‰æ–¹æ³•è°ƒç”¨é“¾çš„å®Œæ•´æ€§

## 4. AGP8 é€‚é…å…³é”®æŠ€æœ¯ç‚¹

### 4.1 API è¿ç§»å¯¹æ¯”

| ç‰¹æ€§   | Transform API (æ—§)     | Instrumentation API (æ–°)   |
| ---- | --------------------- | ------------------------- |
| æ³¨å†Œæ–¹å¼ | `registerTransform()` | `transformClassesWith()`  |
| å‚æ•°ä¼ é€’ | Transform æ„é€ å‡½æ•°        | InstrumentationParameters |
| ç±»è¿‡æ»¤  | `isIncremental()`     | `isInstrumentable()`      |
| å¤„ç†ç²’åº¦ | æ–‡ä»¶çº§åˆ«                  | ç±»çº§åˆ«                       |
| ç¼“å­˜æ”¯æŒ | åŸºç¡€æ”¯æŒ                  | å¼ºåŒ–å¢é‡æ„å»º                    |

### 4.2 æ€§èƒ½ä¼˜åŒ–æªæ–½

```kotlin
override fun isInstrumentable(classData: ClassData): Boolean {
    // åœ¨å­—èŠ‚ç è§£æå‰å°±è¿‡æ»¤æ‰ä¸éœ€è¦çš„ç±»
    return !isSystemClass(classData.className)
}

private val methodMap = ConcurrentHashMap<String, Int>()
private val methodIdGenerator = AtomicInteger(1)

override fun visitMaxs(maxStack: Int, maxLocals: Int) {
    // ç¡®ä¿æ ˆå¤§å°è¶³å¤Ÿå®¹çº³æ’å…¥çš„æŒ‡ä»¤
    super.visitMaxs(maxStack + 4, maxLocals)
}
```

### 4.3 æ„å»ºé…ç½®æœ€ä½³å®è·µ

```gradle
// build.gradle æ¨èé…ç½®
matrix {
    logLevel "D"
    trace {
        enable = true
        blackListFile = "${project.projectDir}/matrixTrace/blackMethodList.txt"
    }
}
```

## 5. å®é™…åº”ç”¨æ•ˆæœ

### 5.1 ç¼–è¯‘æ—¶è¾“å‡º

```
> Task :app:transformClassesWithMatrixTraceForDebug
Matrix.TraceClassVisitorFactory: å®ä¾‹åŒ–.
MatrixTracePlugin: variant:debug
MatrixTraceClassVisitor: å¤„ç†ç±» com/example/MainActivity
MatrixTraceClassVisitor: æ’æ¡©æ–¹æ³• onCreate()V
MatrixTraceClassVisitor: æ’æ¡©æ–¹æ³• onResume()V
...
> Task :app:mergeAppTestReleaseGeneratedProguardFiles
> Task :app:saveMappingAppDevDebug
> Task :app:saveMappingAppDevRelease
> Task :app:saveMappingAppProDebug
> Task :app:saveMappingAppProRelease
> Task :app:saveMappingAppTestDebug

> Task :app:saveMappingAppTestRelease
[D][MatrixTracePlugin] å¼€å§‹å­˜å‚¨mapping

```

### 5.2 æ–¹æ³•æ˜ å°„æ–‡ä»¶ç¤ºä¾‹

```
...
271272,com.lagos.emobility.driver.ui.underway.google.GoogleNavigationController$initializeNavigationApi$2$1.onError(I)V
271273,com.lagos.emobility.driver.ui.underway.google.GoogleNavigationController.initializeNavigationApi$lambda$1(Lcom.lagos.emobility.driver.ui.underway.google.GoogleNavigationController;Lkotlin.jvm.functions.Function2;)V
271274,com.lagos.emobility.driver.ui.underway.google.GoogleNavigationController.withMapAsync$lambda$2(Lkotlin.jvm.functions.Function1;Lcom.google.android.gms.maps.GoogleMap;)V
1048574,message_dispatch_start
...
```

### 5.3 è¿è¡Œæ—¶ç›‘æ§æ•°æ®

```kotlin
// ç”Ÿæˆçš„å­—èŠ‚ç è°ƒç”¨ç¤ºä¾‹
public void onCreate(Bundle savedInstanceState) {
    MethodBeat.i(1);  // æ–¹æ³•è¿›å…¥
    try {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        // ... ä¸šåŠ¡é€»è¾‘
    } finally {
        MethodBeat.o(1);  // æ–¹æ³•é€€å‡º
    }
}
```

## 6 å †æ ˆè§£æ

### 6.1å †æ ˆæ•°æ®æ ¼å¼è§£æ:

**åŸå§‹æ•°æ®ç»“æ„**

```
{
  "nameValuePairs": {
    "machine": "HIGH",
    "cpu_app": 0,
    "mem": 8055660544,
    "mem_free": 3264324,
    "detail": "NORMAL",
    "cost": 905,
    "scene": "com.lagos.emobility.driver.ui.underway.OrderUnderwayActivity",
    "stack": "0,1048574,1,905\n1,258336,1,903\n2,20604,1,897\n3,22106,1,186\n4,35700,1,186\n5,21656,1,186\n6,26128,1,181\n7,81196,1,137\n8,23665,1,137\n3,24006,1,603\n4,58165,1,503\n5,22284,1,338\n6,64326,1,338\n7,60162,1,322\n8,60154,1,322\n9,35700,1,162\n10,35723,1,162\n11,35700,1,162\n12,64378,1,162\n13,63526,1,121\n14,65534,1,110\n15,81196,1,110\n16,63398,1,110\n17,35700,1,99\n18,35723,1,99\n19,35700,1,99\n20,64365,1,99\n21,17766,1,84\n9,63491,1,160\n10,63497,1,160\n",
    "stackKey": "60154|",
    "tag": "Trace_EvilMethod",
    "process": "com.lagos.emobility.driver",
    "time": 1750662360918
  }
}
```

**å †æ ˆæ ¼å¼è¯´æ˜**

```css
æ ¼å¼: depth,methodId,count,cost
- depth: è°ƒç”¨æ·±åº¦ï¼ˆ0ä¸ºæ ¹è°ƒç”¨ï¼‰
- methodId: æ–¹æ³•å”¯ä¸€æ ‡è¯†ç¬¦
- count: è°ƒç”¨æ¬¡æ•°
- cost: è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
ç‰¹æ®Šæ–¹æ³•ID:
- 1048574 (0xFFFFF-1): message_dispatch_start æ¶ˆæ¯åˆ†å‘èµ·å§‹ç‚¹
- å…¶ä»–ID: å¯¹åº” methodMapping.txt ä¸­çš„æ–¹æ³•æ˜ å°„
```

### Jsè§£æè„šæœ¬

**å®Œæ•´è§£æå·¥å…·**

```javascript
const fs = require('fs');

function parseStackTrace(mappingFilePath, stackInput) {
try {
  // è¯»å–mappingæ–‡ä»¶
  let mapping = {};
  if (fs.existsSync(mappingFilePath)) {
    const mappingContent = fs.readFileSync(mappingFilePath, 'utf8');
    
    // è§£æmappingæ–‡ä»¶æ ¼å¼: methodId,methodSignature
    const lines = mappingContent.trim().split('\n');
    lines.forEach(line => {
      if (line.trim()) {
        const commaIndex = line.indexOf(',');
        if (commaIndex > 0) {
          const id = parseInt(line.substring(0, commaIndex).trim());
          const signature = line.substring(commaIndex + 1).trim();
          
          // ç®€åŒ–æ–¹æ³•ç­¾åæ˜¾ç¤º
          const simplifiedName = simplifyMethodSignature(signature);
          mapping[id] = {
            full: signature,
            simple: simplifiedName
          };
        }
      }
    });
    
    console.log(`æˆåŠŸåŠ è½½ ${Object.keys(mapping).length} ä¸ªæ–¹æ³•æ˜ å°„`);
  } else {
    console.log(`Warning: Mapping file ${mappingFilePath} not found`);
  }

  // è¯»å–å †æ ˆæ•°æ®ï¼ˆæ”¯æŒæ–‡ä»¶æˆ–å­—ç¬¦ä¸²ï¼‰
  let stackString;
  if (fs.existsSync(stackInput)) {
    stackString = fs.readFileSync(stackInput, 'utf8');
    console.log(`ä»æ–‡ä»¶è¯»å–å †æ ˆæ•°æ®: ${stackInput}`);
  } else {
    stackString = stackInput;
    console.log(`ä½¿ç”¨ä¼ å…¥çš„å †æ ˆå­—ç¬¦ä¸²`);
  }

  // è§£æå †æ ˆæ•°æ®
  const lines = stackString.trim().split('\\n');
  console.log("lines----->",lines);
  const parsedStack = [];

  console.log('\nå †æ ˆè°ƒç”¨ä¿¡æ¯:');
  console.log('='.repeat(100));

  lines.forEach((line, index) => {
if (line.trim()) {
  const parts = line.split(',');
  if (parts.length >= 4) {
    const level = parseInt(parts[0]);
    const methodId = parseInt(parts[1]);
    const callCount = parseInt(parts[2]);
    const duration = parseInt(parts[3]);
    
    const methodInfo = mapping[methodId];
    const methodName = methodInfo ? methodInfo.full : `Unknown_${methodId}`;
    
    // ç®€å•çš„å±‚çº§ç¼©è¿›
    const indent = 'â”‚ '.repeat(level) + (level > 0 ? 'â”œâ”€ ' : '');
    
    // ç®€æ´çš„å•è¡Œæ˜¾ç¤º
    console.log(`${indent}${methodName} (${duration}ms)`);
    
    parsedStack.push({
      level,
      methodId,
      methodName,
      fullSignature: methodInfo ? methodInfo.full : `Method_${methodId}`,
      callCount,
      duration
    });
  }
}
});

  // ç»Ÿè®¡ä¿¡æ¯
  const totalDuration = parsedStack.reduce((sum, item) => sum + item.duration, 0);
  const maxLevel = Math.max(...parsedStack.map(item => item.level));
  const totalCalls = parsedStack.reduce((sum, item) => sum + item.callCount, 0);
  
  console.log('='.repeat(100));

  // æŒ‰å±‚çº§ç»Ÿè®¡
  const levelStats = {};
  parsedStack.forEach(item => {
    if (!levelStats[item.level]) {
      levelStats[item.level] = { count: 0, totalDuration: 0, totalCalls: 0 };
    }
    levelStats[item.level].count++;
    levelStats[item.level].totalDuration += item.duration;
    levelStats[item.level].totalCalls += item.callCount;
  });

  // è€—æ—¶æœ€é•¿çš„æ–¹æ³•
  const sortedByDuration = [...parsedStack].sort((a, b) => b.duration - a.duration);
  console.log('\nğŸ”¥ è€—æ—¶æœ€é•¿çš„å‰10ä¸ªæ–¹æ³•:');
  sortedByDuration.slice(0, 10).forEach((item, index) => {
    console.log(`   ${index + 1}. ${item.methodName} - ${item.duration}ms (${item.callCount}æ¬¡è°ƒç”¨)`);
  });

  return parsedStack;

} catch (error) {
  console.error('âŒ è§£æé”™è¯¯:', error.message);
  return null;
}
}

// ç®€åŒ–æ–¹æ³•ç­¾åæ˜¾ç¤º
function simplifyMethodSignature(signature) {
try {
  // æå–ç±»åå’Œæ–¹æ³•å
  const lastSlash = signature.lastIndexOf('/');
  const firstDot = signature.indexOf('.', lastSlash);
  const firstParen = signature.indexOf('(');
  
  if (lastSlash >= 0 && firstDot > lastSlash && firstParen > firstDot) {
    const className = signature.substring(lastSlash + 1, firstDot);
    const methodName = signature.substring(firstDot + 1, firstParen);
    
    // æå–å‚æ•°ç±»å‹ï¼ˆç®€åŒ–æ˜¾ç¤ºï¼‰
    const paramsPart = signature.substring(firstParen + 1, signature.indexOf(')'));
    const simplifiedParams = simplifyParams(paramsPart);
    
    return `${className}.${methodName}(${simplifiedParams})`;
  }
  
  return signature;
} catch (e) {
  return signature;
}
}

// ç®€åŒ–å‚æ•°ç±»å‹æ˜¾ç¤º
function simplifyParams(params) {
if (!params) return '';

const typeMap = {
  'Z': 'boolean',
  'B': 'byte',
  'C': 'char',
  'S': 'short',
  'I': 'int',
  'J': 'long',
  'F': 'float',
  'D': 'double',
  'V': 'void'
};

let result = '';
let i = 0;

while (i < params.length) {
  if (params[i] === 'L') {
    // å¯¹è±¡ç±»å‹
    const semicolon = params.indexOf(';', i);
    if (semicolon > i) {
      const className = params.substring(i + 1, semicolon);
      const simpleName = className.substring(className.lastIndexOf('/') + 1);
      result += simpleName;
      i = semicolon + 1;
    } else {
      i++;
    }
  } else if (params[i] === '[') {
    // æ•°ç»„ç±»å‹
    result += '[]';
    i++;
  } else if (typeMap[params[i]]) {
    result += typeMap[params[i]];
    i++;
  } else {
    i++;
  }
  
  if (i < params.length && result && !result.endsWith('[]')) {
    result += ', ';
  }
}

return result;
}

// ä¸»å‡½æ•°
function main() {
const args = process.argv.slice(2);

if (args.length < 2) {
  console.log('ğŸš€ ä½¿ç”¨æ–¹æ³•: node stack-parser.js <mappingæ–‡ä»¶è·¯å¾„> <å †æ ˆæ–‡ä»¶è·¯å¾„æˆ–å­—ç¬¦ä¸²>');
  console.log('ğŸ“ ç¤ºä¾‹1 (æ–‡ä»¶): node stack-parser.js mapping.txt stack.txt');
  console.log('ğŸ“ ç¤ºä¾‹2 (å­—ç¬¦ä¸²): node stack-parser.js mapping.txt "0,1048574,1,710"');
  console.log('ğŸ“‹ Mappingæ–‡ä»¶æ ¼å¼: methodId,methodSignature');
  return;
}

const mappingFile = args[0];
const stackInput = args[1];

console.log(`ğŸ“ Mappingæ–‡ä»¶: ${mappingFile}`);
console.log(`ğŸ” è§£æå †æ ˆæ•°æ®...\n`);

parseStackTrace(mappingFile, stackInput);
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬
if (require.main === module) {
main();
}

// å¯¼å‡ºå‡½æ•°ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
module.exports = { parseStackTrace };
```

**ä½¿ç”¨æ–¹å¼**
`node trace_parser.js ~/code/methodMapping.txt` "0,1048574,1,905\n1,258336,1...."

```css
 Mappingæ–‡ä»¶: /Users/heyufei/code/methodMapping.txt
ğŸ” è§£æå †æ ˆæ•°æ®...

æˆåŠŸåŠ è½½ 270940 ä¸ªæ–¹æ³•æ˜ å°„
ä½¿ç”¨ä¼ å…¥çš„å †æ ˆå­—ç¬¦ä¸²
lines-----> [
  '0,1048574,1,905', '1,258336,1,903',
  '2,20604,1,897',   '3,22106,1,186',
  '4,35700,1,186',   '5,21656,1,186',
  '6,26128,1,181',   '7,81196,1,137',
  '8,23665,1,137',   '3,24006,1,603',
  '4,58165,1,503',   '5,22284,1,338',
  '6,64326,1,338',   '7,60162,1,322',
  '8,60154,1,322',   '9,35700,1,162',
  '10,35723,1,162',  '11,35700,1,162',
  '12,64378,1,162',  '13,63526,1,121',
  '14,65534,1,110',  '15,81196,1,110',
  '16,63398,1,110',  '17,35700,1,99',
  '18,35723,1,99',   '19,35700,1,99',
  '20,64365,1,99',   '21,17766,1,84',
  '9,63491,1,160',   '10,63497,1,160',
  ''
]

å †æ ˆè°ƒç”¨ä¿¡æ¯:
====================================================================================================
message_dispatch_start (905ms)
â”‚ â”œâ”€ com.lagos.emobility.driver.ui.underway.OrderUnderwayActivity$4.run()V (903ms)
â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.NavigationView.onCreate(Landroid.os.Bundle;)V (897ms)
â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.environment.l.bl()Lcom.google.android.libraries.navigation.internal.aal.n; (186ms)
â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aes.e.a()Ljava.lang.Object; (186ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.environment.ay.a()Ljava.lang.Object; (186ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aal.n.c(Landroid.content.Context;Lcom.google.android.libraries.navigation.internal.aal.ih;Lcom.google.android.libraries.navigation.internal.aal.gf;Lcom.google.android.libraries.navigation.internal.aal.j;Lcom.google.android.libraries.navigation.internal.vi.e;)Lcom.google.android.libraries.navigation.internal.aal.n; (181ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.yg.bv.a()Ljava.lang.Object; (137ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aal.ay.a()Ljava.lang.Object; (137ms)
â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aal.co.aB(Lcom.google.android.gms.maps.GoogleMapOptions;ZLcom.google.android.libraries.navigation.internal.aal.bf;Lcom.google.android.libraries.navigation.internal.aal.n;Lcom.google.android.libraries.navigation.internal.aal.cp;Lcom.google.android.libraries.navigation.internal.aal.gf;)Lcom.google.android.libraries.navigation.internal.aal.co; (603ms)
â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.lv.ct.a(Ljava.lang.String;Lcom.google.android.libraries.navigation.internal.aal.bf;Lcom.google.android.libraries.navigation.internal.aal.n;Ljava.lang.String;Ljava.lang.Integer;ILandroid.view.View;Lcom.google.android.libraries.navigation.internal.aal.ab;ZLandroid.widget.TextView;Lcom.google.android.libraries.navigation.internal.aal.ec;Lcom.google.android.libraries.navigation.internal.aal.cb;Lcom.google.android.libraries.navigation.internal.aal.hy;ZLcom.google.android.libraries.navigation.internal.aal.d;Lcom.google.android.libraries.navigation.internal.aal.ag;ZLcom.google.android.libraries.navigation.internal.aal.da;Lcom.google.android.libraries.navigation.internal.aal.bo;)Lcom.google.android.libraries.navigation.internal.aal.ed; (503ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.environment.u.run()V (338ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.ph.c.h()V (338ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.nt.h.h()V (322ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.nt.h.b()Lcom.google.android.libraries.navigation.internal.nt.d; (322ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aes.e.a()Ljava.lang.Object; (162ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aes.m.a()Ljava.lang.Object; (162ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aes.e.a()Ljava.lang.Object; (162ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.ph.q.a()Ljava.lang.Object; (162ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.pb.gi.<init>(Ljava.lang.String;Ljava.lang.Integer;Landroid.content.res.Resources;Lcom.google.android.libraries.navigation.internal.px.x;Lcom.google.android.libraries.navigation.internal.nu.m;Landroid.content.Context;Lcom.google.android.libraries.navigation.internal.pf.y;Lcom.google.android.libraries.navigation.internal.acm.an;Lcom.google.android.libraries.navigation.internal.aep.a;Lcom.google.android.libraries.navigation.internal.pb.gn;Lcom.google.android.libraries.navigation.internal.aep.a;Lcom.google.android.libraries.navigation.internal.aep.a;Lcom.google.android.libraries.navigation.internal.pq.k;Landroid.content.Context;Lcom.google.android.libraries.navigation.internal.gb.f;Lcom.google.android.libraries.navigation.internal.kh.b;Lcom.google.android.libraries.navigation.internal.oa.p;Lcom.google.android.libraries.navigation.internal.oz.c;Lcom.google.android.libraries.navigation.internal.mg.b;Lcom.google.android.libraries.navigation.internal.gn.p;Lcom.google.android.libraries.navigation.internal.nd.a;Lcom.google.android.libraries.navigation.internal.ov.s;Lcom.google.android.libraries.navigation.internal.ja.e;Lcom.google.android.libraries.navigation.internal.kc.c;Lcom.google.android.libraries.navigation.internal.ps.d;Lcom.google.android.libraries.navigation.internal.hr.f;Lcom.google.android.libraries.navigation.internal.do.c;Lcom.google.android.libraries.navigation.internal.qm.h;Lcom.google.android.libraries.navigation.internal.oz.a;Lcom.google.android.libraries.navigation.internal.qo.a;Lcom.google.android.libraries.navigation.internal.hu.v;Lcom.google.android.libraries.navigation.internal.zk.bl;Lcom.google.android.libraries.navigation.internal.zk.bl;Ljava.util.concurrent.Executor;Ljava.util.concurrent.Executor;Lcom.google.android.libraries.navigation.internal.zk.bl;Lcom.google.android.libraries.navigation.internal.qi.ce;Lcom.google.android.libraries.navigation.internal.ot.e;Lcom.google.android.libraries.navigation.internal.px.cm;Lcom.google.android.libraries.navigation.internal.pa.g;Lcom.google.android.libraries.navigation.internal.yg.bs;Lcom.google.android.libraries.navigation.internal.nu.r;Lcom.google.android.libraries.navigation.internal.qg.a;Lcom.google.android.libraries.navigation.internal.qq.c;Lcom.google.android.libraries.geo.mapcore.api.model.ba;Z)V (121ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.pk.cv.<init>(Lcom.google.android.libraries.navigation.internal.zk.bl;Lcom.google.android.libraries.navigation.internal.yg.bs;)V (110ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.yg.bv.a()Ljava.lang.Object; (110ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.pb.fw.a()Ljava.lang.Object; (110ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aes.e.a()Ljava.lang.Object; (99ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aes.m.a()Ljava.lang.Object; (99ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.aes.e.a()Ljava.lang.Object; (99ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.ph.m.a()Ljava.lang.Object; (99ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.geo.mapcore.renderer.ax.<init>(Landroid.content.Context;Lcom.google.android.libraries.navigation.internal.kh.b;Lcom.google.android.libraries.navigation.internal.nd.a;Lcom.google.android.libraries.navigation.internal.afp.a;Landroid.content.res.Resources;)V (84ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.pb.gi.a()Lcom.google.android.libraries.navigation.internal.nt.d; (160ms)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€ com.google.android.libraries.navigation.internal.pb.gi.i()Lcom.google.android.libraries.navigation.internal.nt.d; (160ms)
====================================================================================================

ğŸ”¥ è€—æ—¶æœ€é•¿çš„å‰10ä¸ªæ–¹æ³•:
   1. message_dispatch_start - 905ms (1æ¬¡è°ƒç”¨)
   2. com.lagos.emobility.driver.ui.underway.OrderUnderwayActivity$4.run()V - 903ms (1æ¬¡è°ƒç”¨)
   3. com.google.android.libraries.navigation.NavigationView.onCreate(Landroid.os.Bundle;)V - 897ms (1æ¬¡è°ƒç”¨)
   4. com.google.android.libraries.navigation.internal.aal.co.aB(Lcom.google.android.gms.maps.GoogleMapOptions;ZLcom.google.android.libraries.navigation.internal.aal.bf;Lcom.google.android.libraries.navigation.internal.aal.n;Lcom.google.android.libraries.navigation.internal.aal.cp;Lcom.google.android.libraries.navigation.internal.aal.gf;)Lcom.google.android.libraries.navigation.internal.aal.co; - 603ms (1æ¬¡è°ƒç”¨)
   5. com.google.android.libraries.navigation.internal.lv.ct.a(Ljava.lang.String;Lcom.google.android.libraries.navigation.internal.aal.bf;Lcom.google.android.libraries.navigation.internal.aal.n;Ljava.lang.String;Ljava.lang.Integer;ILandroid.view.View;Lcom.google.android.libraries.navigation.internal.aal.ab;ZLandroid.widget.TextView;Lcom.google.android.libraries.navigation.internal.aal.ec;Lcom.google.android.libraries.navigation.internal.aal.cb;Lcom.google.android.libraries.navigation.internal.aal.hy;ZLcom.google.android.libraries.navigation.internal.aal.d;Lcom.google.android.libraries.navigation.internal.aal.ag;ZLcom.google.android.libraries.navigation.internal.aal.da;Lcom.google.android.libraries.navigation.internal.aal.bo;)Lcom.google.android.libraries.navigation.internal.aal.ed; - 503ms (1æ¬¡è°ƒç”¨)
   6. com.google.android.libraries.navigation.environment.u.run()V - 338ms (1æ¬¡è°ƒç”¨)
   7. com.google.android.libraries.navigation.internal.ph.c.h()V - 338ms (1æ¬¡è°ƒç”¨)
   8. com.google.android.libraries.navigation.internal.nt.h.h()V - 322ms (1æ¬¡è°ƒç”¨)
   9. com.google.android.libraries.navigation.internal.nt.h.b()Lcom.google.android.libraries.navigation.internal.nt.d; - 322ms (1æ¬¡è°ƒç”¨)
   10. com.google.android.libraries.navigation.environment.l.bl()Lcom.google.android.libraries.navigation.internal.aal.n; - 186ms (1æ¬¡è°ƒç”¨)
```

## 7. é—®é¢˜æ’æŸ¥æŒ‡å—

### 7.1 å¸¸è§ç¼–è¯‘é”™è¯¯

**é”™è¯¯ 1ï¼šASM ç‰ˆæœ¬å†²çª**

```
java.lang.NoSuchMethodError: org.objectweb.asm.ClassVisitor.<init>
```

**è§£å†³æ–¹æ¡ˆï¼š**

```gradle
configurations.all {
    resolutionStrategy {
        force 'org.ow2.asm:asm:9.6'
        force 'org.ow2.asm:asm-commons:9.6'
    }
}
```

**é”™è¯¯ 2ï¼šæ–¹æ³•æ˜ å°„æ–‡ä»¶æœªç”Ÿæˆ**

```
æ£€æŸ¥ä»»åŠ¡ä¾èµ–å…³ç³»æ˜¯å¦æ­£ç¡®é…ç½®
```

**è§£å†³æ–¹æ¡ˆï¼š**

```kotlin
// ç¡®ä¿ saveMapping ä»»åŠ¡åœ¨æ­£ç¡®çš„æ—¶æœºæ‰§è¡Œ
project.tasks.matching { task ->
    task.name.contains("transform")
}.configureEach { transformTask ->
    transformTask.finalizedBy(mappingTask)
}
```

### 7.2 è¿è¡Œæ—¶é—®é¢˜

**é—®é¢˜1ï¼šæ–¹æ³•æ‰¾ä¸åˆ°**

```
java.lang.NoSuchMethodError: MethodBeat.i(I)V
```

**è§£å†³æ–¹æ¡ˆï¼š**

```proguard
# proguard-rules.pro
-keep class com.tencent.matrix.trace.core.MethodBeat {
    public static *** i(int);
    public static *** o(int);
}
```

**é—®é¢˜2:æ’æ¡©æ— æ•ˆ,æœªå¯åŠ¨trace ,trace task ç©º**

```
tag[Trace_EvilMethod]type[0];key[null];content[{"machine":"HIGH","cpu_app":0,"mem":8055660544,"mem_free":3377132,"detail":"NORMAL","cost":1740,"scene":"com.lagos.emobility.driver.ui.underway.OrderUnderwayActivity","stack":"","stackKey":"","tag":"Trace_EvilMethod","process":"com.lagos.emobility.driver","time":1750319930441}]

```

**è§£å†³æ–¹æ¡ˆ**

```java
private TracePlugin configTracePlugin(DynamicConfigImplDemo dynamicConfig) {
		//1. é…ç½®è®¾ç½®TracePlugin
        TraceConfig config = new TraceConfig.Builder()
                .dynamicConfig(dynamicConfig)
                .enableAnrTrace(true)
                .enableAppMethodBeat(dynamicConfig.isTraceEnable())
                .enableEvilMethodTrace(dynamicConfig.isTraceEnable())
                .enableTouchEventTrace(true)
                .build();
        //fix matrix sdk ç‰ˆæœ¬é™åˆ¶
		//2. æ‰‹åŠ¨è°ƒç”¨ UIThreadMonitor.getMonitor().init(config);
        if (!UIThreadMonitor.getMonitor().isInit()) {
            try {
                UIThreadMonitor.getMonitor().init(config);
            } catch (java.lang.RuntimeException e) {
                MatrixLog.e(TAG, "[start] RuntimeException:%s", e);
            }
        }

        return new TracePlugin(config);
    }
```

**åˆ†æ**
![ba6fb2ecc3bc16141cf6cdde0f971e58.png](/resources/ed1c69ebb5104369a11a70110f535b91.png)

```
UIThreadMonitor.getMonitor().init(traceConfig);
->>  LooperMonitor.registe(xxxx)
->dispatchStart()
-->æ’æ¡©AppMethodBeat.i(AppMethodBeat.METHOD_ID_DISPATCH);
...
EvilMethodTracer.AnalyseTask.analyse()
-->check AppMethodBeat.METHOD_ID_DISPATCH
```

![57bc0547e1af021ef5ba8065bbfd363e.png](/resources/cdbffe37521d443c9c1fb33976f861dd.png)

> æ…¢æ–¹æ³•æ£€æµ‹ å…¥å£å¿…é¡»æ˜¯è¿™ä¸ªæ¥å…¥ç‚¹(æ¶ˆæ¯åˆ†å‘èµ·å§‹ç‚¹)

## 8. æ€»ç»“ä¸å±•æœ›

### 8.1 é€‚é…æˆæœ

1. **å®Œå…¨å…¼å®¹ AGP8**ï¼šæˆåŠŸè¿ç§»åˆ°æ–°çš„ Instrumentation API
2. **åŠŸèƒ½ä¿æŒå®Œæ•´**ï¼šæ‰€æœ‰åŸæœ‰ç›‘æ§åŠŸèƒ½æ­£å¸¸å·¥ä½œ
3. **è§£æå †æ ˆ**ï¼šå¯ä»¥æ­£å¸¸è§£æé‡‡é›†åˆ°çš„å †æ ˆæ•°æ®,ç”¨äºåç»­åˆ†æ

### 8.2 æŠ€æœ¯æ”¶è·

- æ·±å…¥ç†è§£ AGP8 æ–°æ¶æ„å’Œ API è®¾è®¡
- æŒæ¡ ASM å­—èŠ‚ç æ“ä½œçš„æœ€ä½³å®è·µ
- å­¦ä¼š Gradle æ’ä»¶å¼€å‘çš„ç°ä»£åŒ–æ¨¡å¼

### 8.3 åç»­ä¼˜åŒ–æ–¹å‘

1. **æ™ºèƒ½é‡‡æ ·ç­–ç•¥**ï¼šæ ¹æ®è®¾å¤‡æ€§èƒ½åŠ¨æ€è°ƒæ•´é‡‡æ ·ç‡
2. **å¢é‡æ’æ¡©ä¼˜åŒ–**ï¼šè¿›ä¸€æ­¥åˆ©ç”¨ AGP8 çš„å¢é‡æ„å»ºèƒ½åŠ›
3. **å¤šæ¨¡å—æ”¯æŒ**ï¼šæ‰©å±•åˆ° Android Library é¡¹ç›®
4. **äº‘ç«¯åˆ†æé›†æˆ**ï¼šä¸ç›‘æ§åå°æ·±åº¦é›†æˆ

é€šè¿‡è¿™æ¬¡ TraceCanary é€‚é… AGP8 çš„å®è·µï¼Œæˆ‘ä»¬ä¸ä»…è§£å†³äº†å…¼å®¹æ€§é—®é¢˜ï¼Œè¿˜è·å¾—äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚è¿™ä¸ºåç»­çš„ Matrix å…¶ä»–æ¨¡å—é€‚é…æä¾›äº†å®è´µçš„ç»éªŒå’ŒæŠ€æœ¯åŸºç¡€ã€‚
