---
layout: post
title: aidl 小结
abbrlink: 1495300251284f78adf1b5350fb76201
tags: []
categories:
  - framework
date: 1754560906398
updated: 1756109349168
---

### 服务端

- 实现XXX.Stub()
- native: BBinder
- kernel:binder\_node

### 客户端

- 获取proxy: XXX.Stub.asInterface(Ibinder)
- native:BpBinder\
  ![67ebc25cc496a6efa45efe954e368c37.png](/resources/262443e314bd46f080017842264c98cb.png)\
  ![cfb0e7082290acc72c1b2f9755e2e4b0.png](/resources/0a6e1a65ae3c4abca2da39f0e5d81b2c.png)
- kernel:binder\_ref

### `in` `out` `inout`

> 修改参数,同步变化

- `in`: 数据只能由客户端---->服务器
- `out`数据只能由服务端---->客户端
- `inout`数据双向流动

### `oneway`

- 修饰方法,不能有返回值,也不可携带 `out` ,`inout`
- 远程调用不会阻塞,发送事务数据后立即返回
- 发生异常,客户端无法感知,需要额外处理!!!

> 短时间内多次调用,会加到`async_todo`队列,可能会导致目标进程Binder内存耗尽(1M/2). 导致后续调用失败(如果目标进程 Binder操作比较耗时), 需要特别注意

### Binder跨进程双向通信

![fa555e2ad1c8d33520ce18c6303b3b0a.png](/resources/b90d7be8aea04dad84289cb725a3f847.png)

### linktodeath

- 死亡通知

```java
@Override
public void setCallback(IChangeCallback callback) throws RemoteException {
    mCallBack = callback;
    //监听客户端的进程是否死了
    mCallBack.asBinder().linkToDeath(new DeathRecipient() {
        @Override
        public void binderDied() {
            Log.i("test","linkToDeath binderDied");
        }
    },0);
}

```

### aidl 通信 ---> Messenger 方式 (注意不是Message)

![34f2196f0b6f9b47fb2eb110446ed62e.png](/resources/f0c4b54c36424bac88cc6555a26edca6.png)

```java
oneway interface IMessenger {
    void send(in Message msg);
}

...

public final class Messenger implements Parcelable {
    private final IMessenger mTarget;

    /**
     * Create a new Messenger pointing to the given Handler.  Any Message
     * objects sent through this Messenger will appear in the Handler as if
     * {@link Handler#sendMessage(Message) Handler.sendMessage(Message)} had
     * been called directly.
     * 
     * @param target The Handler that will receive sent messages.
     */
    //服务端 调用
    public Messenger(Handler target) {
        // new MessengerImpl() : IMessenger.Stub
        mTarget = target.getIMessenger();
    }
    //客户端调用
    public Messenger(IBinder target) {
        mTarget = IMessenger.Stub.asInterface(target);
    }
    ...
    public IBinder getBinder() {
        return mTarget.asBinder();
    }
}

//XXXStub : android.os.Binder
public android.os.IBinder asBinder()
{
  return this;
}
```

参考 [Android Framework实战开发-binder通信常见（oneway，in，out，inout）元素介绍及binder双向通信的实现](https://blog.csdn.net/learnframework/article/details/119812520?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522dcc028a90562d74a406fee9addc29fc9%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D\&request_id=dcc028a90562d74a406fee9addc29fc9\&biz_id=0\&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-2-119812520-null-null.nonecase\&utm_term=oneway\&spm=1018.2226.3001.4450)
